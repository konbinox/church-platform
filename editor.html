<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>教会聚会内容编辑器</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: "Microsoft YaHei", sans-serif;
      background: #f5f7fa;
      color: #2d3748;
      height: 100vh;
      overflow: hidden;
    }
    .editor-layout {
      display: flex;
      height: 100vh;
    }
    .sidebar-nav {
      width: 180px;
      background: #2d3748;
      color: white;
      overflow-y: auto;
      z-index: 1000;
    }
    .nav-header {
      padding: 20px;
      border-bottom: 1px solid #4a5568;
    }
    .nav-header h3 {
      font-size: 18px;
      margin: 0;
    }
    .page-count {
      font-size: 14px;
      color: #a0aec0;
      margin-top: 8px;
    }
    .pages-list {
      padding: 10px;
    }
    .page-item {
      padding: 12px;
      margin: 8px 0;
      background: rgba(255,255,255,0.1);
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .page-item:hover {
      background: rgba(255,255,255,0.2);
    }
    .page-item.active {
      background: rgba(52, 152, 219, 0.5);
    }
    .page-title-small {
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .editor-main {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    #toggle-mode {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 2000;
      padding: 10px 20px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    #toggle-mode:hover {
      background: #2980b9;
    }
    .preview-mode {
      overflow: hidden;
    }
    #preview-container {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      z-index: 1000;
    }
    #preview-bg {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background-size: cover;
      background-position: center;
      z-index: -1;
    }
    .preview-main {
      position: relative;
      margin-left: 180px;
      height: 100vh;
    }
    .preview-content {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100%;
      padding: 20px;
      color: white;
      text-align: center;
      text-shadow: 0 2px 6px rgba(0,0,0,0.6);
    }
    #preview-title {
      font-size: 48px;
      margin-bottom: 30px;
    }
    #preview-text {
      font-size: 28px;
      line-height: 1.6;
      max-width: 900px;
    }
    .preview-page-number {
      position: absolute;
      bottom: 30px;
      right: 30px;
      background: rgba(0,0,0,0.5);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <!-- 编辑模式 -->
  <div class="editor-layout" id="editor-container">
    <div class="sidebar-nav">
      <div class="nav-header">
        <h3><i class="fas fa-list"></i> 页面列表</h3>
        <div class="page-count">共 30 页</div>
      </div>
      <div class="pages-list" id="pages-list"></div>
    </div>
    <div class="editor-main">
      <div id="editor-component"></div>
    </div>
  </div>

  <!-- 预览模式 -->
  <div id="preview-container">
    <div class="sidebar-nav">
      <div class="nav-header">
        <h3><i class="fas fa-list"></i> 页面导航</h3>
        <div class="page-count">共 <span id="preview-total">30</span> 页</div>
      </div>
      <div class="pages-list" id="preview-pages-list"></div>
    </div>
    <div class="preview-main">
      <div id="preview-bg"></div>
      <div class="preview-content">
        <h1 id="preview-title"></h1>
        <div id="preview-text"></div>
        <div class="preview-page-number">
          第 <span id="preview-current">1</span> 页 / 共 <span id="preview-total2">30</span> 页
        </div>
      </div>
    </div>
  </div>

  <button id="toggle-mode">切换到全屏预览</button>

  <script type="module">
    import { renderPageEditor } from './components/page-editor.js';

    let meetingData = {};
    let pages = [];
    let currentPageIndex = 0;

    // ====================
    // 创建 DOM 元素（安全无模板字符串）
    // ====================

    function createPageItem(page, index, isActive) {
      const item = document.createElement('div');
      item.className = `page-item ${isActive ? 'active' : ''}`;
      item.dataset.index = index;

      const titleDiv = document.createElement('div');
      titleDiv.className = 'page-title-small';
      titleDiv.title = page.title || '未命名';
      titleDiv.textContent = page.title || `页面 ${index + 1}`;

      item.appendChild(titleDiv);
      return item;
    }

    function renderPageList() {
      const list = document.getElementById('pages-list');
      list.innerHTML = '';

      pages.forEach((page, i) => {
        const item = createPageItem(page, i, i === currentPageIndex);
        item.addEventListener('click', () => {
          currentPageIndex = i;
          loadPageIntoEditor(i);
          renderPageList();
        });
        list.appendChild(item);
      });
    }

    function renderPreviewNavigation() {
      const list = document.getElementById('preview-pages-list');
      list.innerHTML = '';

      pages.forEach((page, i) => {
        const item = createPageItem(page, i, i === currentPageIndex);
        item.addEventListener('click', () => {
          showPreviewPage(i);
        });
        list.appendChild(item);
      });
    }

    function showPreviewPage(index) {
      currentPageIndex = index;
      const page = pages[index] || {};

      // 标题
      document.getElementById('preview-title').textContent = page.title || `页面 ${index + 1}`;

      // 内容
      const textEl = document.getElementById('preview-text');
      if (page.sections && Array.isArray(page.sections)) {
        let html = '';
        for (const sec of page.sections) {
          if (sec.content) {
            const div = document.createElement('div');
            if (sec.style) {
              for (const [k, v] of Object.entries(sec.style)) {
                div.style[k] = v;
              }
            }
            div.innerHTML = sec.content.replace(/\n/g, '<br>');
            html += div.outerHTML;
          }
        }
        textEl.innerHTML = html;
      } else {
        textEl.textContent = '无内容';
      }

      // 背景
      const bg = page.background || `slide${((index % 23) + 1).toString().padStart(2, '0')}.jpg`;
      document.getElementById('preview-bg').style.backgroundImage = `url('assets/background/${bg}')`;

      // 更新页码
      document.getElementById('preview-current').textContent = index + 1;
      renderPreviewNavigation(); // 重新高亮
    }

    // ====================
    // 数据加载
    // ====================

    async function loadMeetingData() {
      try {
        const res = await fetch('content/default-meeting.json');
        const data = await res.json();
        meetingData = data;
        pages = Object.values(data.pages || {});
        if (pages.length === 0) throw new Error('No pages');
      } catch (e) {
        console.error('加载失败，使用默认30页', e);
        pages = Array.from({ length: 30 }, (_, i) => ({
          id: `page${String(i+1).padStart(2, '0')}`,
          title: `页面 ${i+1}`,
          sections: [{ content: '内容待编辑...', style: { fontSize: '28px' } }]
        }));
      }

      document.getElementById('preview-total').textContent = pages.length;
      document.getElementById('preview-total2').textContent = pages.length;

      renderPageList();
      loadPageIntoEditor(0);
    }

    function loadPageIntoEditor(index) {
      renderPageEditor(pages[index], (updatedPage) => {
        pages[index] = updatedPage;
        // 重建 pages 对象以保留 key
        if (meetingData.pages) {
          const keys = Object.keys(meetingData.pages);
          meetingData.pages = {};
          pages.forEach((p, i) => {
            meetingData.pages[keys[i]] = p;
          });
        }
      });
    }

    // ====================
    // 预览模式
    // ====================

    function initPreviewMode() {
      document.getElementById('preview-container').style.display = 'block';
      showPreviewPage(0);

      // 键盘翻页
      document.addEventListener('keydown', handlePreviewKeydown);
    }

    function handlePreviewKeydown(e) {
      if (e.key === 'ArrowRight' || e.key === ' ') {
        showPreviewPage((currentPageIndex + 1) % pages.length);
      } else if (e.key === 'ArrowLeft') {
        showPreviewPage((currentPageIndex - 1 + pages.length) % pages.length);
      } else if (e.key === 'Escape') {
        exitPreviewMode();
      }
    }

    function exitPreviewMode() {
      document.getElementById('preview-container').style.display = 'none';
      document.removeEventListener('keydown', handlePreviewKeydown);
    }

    // ====================
    // 初始化
    // ====================

    document.getElementById('toggle-mode').addEventListener('click', function() {
      const isPreview = this.textContent.includes('预览');
      if (isPreview) {
        document.getElementById('editor-container').style.display = 'none';
        document.body.classList.add('preview-mode');
        this.textContent = '返回编辑模式';
        initPreviewMode();
      } else {
        document.getElementById('preview-container').style.display = 'none';
        document.getElementById('editor-container').style.display = 'block';
        document.body.classList.remove('preview-mode');
        this.textContent = '切换到全屏预览';
        exitPreviewMode();
      }
    });

    // 启动
    loadMeetingData();
  </script>
</body>
</html>