<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>教会聚会内容编辑器</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    /* 全局样式 */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: "Microsoft YaHei", sans-serif;
      background: #f5f7fa;
      color: #2d3748;
      height: 100vh;
      overflow: hidden;
    }
    /* 编辑器区域 */
    #editor-container {
      width: 100%;
      height: 100vh;
      overflow-y: auto;
      padding: 20px;
      background: #f5f7fa;
    }
    /* 预览区域（全屏） */
    #preview-container {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      z-index: 1000;
    }
    #preview-bg {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background-size: cover;
      background-position: center;
      z-index: -1;
    }
    #preview-content {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      height: 100%;
      padding: 20px;
      color: white;
      text-shadow: 0 2px 6px rgba(0,0,0,0.6);
    }
    #preview-title {
      font-size: 48px;
      margin-bottom: 30px;
    }
    #preview-text {
      font-size: 28px;
      line-height: 1.6;
      max-width: 900px;
    }
    /* 切换按钮 */
    #toggle-mode {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 2000;
      padding: 10px 20px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    #toggle-mode:hover {
      background: #2980b9;
    }
    /* 播放模式：隐藏滚动条 */
    body.preview-mode {
      overflow: hidden;
    }
  </style>
</head>
<body>
  <!-- 预览容器（全屏播放） -->
  <div id="preview-container">
    <div id="preview-bg"></div>
    <div id="preview-content">
      <h1 id="preview-title"></h1>
      <div id="preview-text"></div>
    </div>
  </div>

  <!-- 编辑器容器 -->
  <div id="editor-container">
    <!-- 内容由 page-editor.js 动态生成 -->
  </div>

  <!-- 切换模式按钮 -->
  <button id="toggle-mode">切换到全屏预览</button>

  <!-- 加载专业编辑器 -->
  <script type="module">
    // 1. 导入编辑器
    import { renderPageEditor } from './components/page-editor.js';

    // 2. 加载默认数据（从 default-meeting.json）
    let meetingData = {};
    let currentPageIndex = 0;
    let currentBgIndex = 1;

    async function loadMeetingData() {
      try {
        const res = await fetch('content/default-meeting.json');
        meetingData = await res.json();
        const pages = Object.values(meetingData.pages || {});
        if (pages.length > 0) {
          renderEditorForPage(pages[0]);
        }
      } catch (e) {
        console.error('加载数据失败，使用默认页面', e);
        renderEditorForPage({
          id: 'page01',
          title: '默认页面',
          sections: [{ type: 'text', content: '欢迎使用编辑器！', style: { fontSize: '28px' } }]
        });
      }
    }

    // 3. 渲染编辑器
    function renderEditorForPage(page) {
      renderPageEditor(page, (updatedPage) => {
        // 更新页面数据
        const pages = Object.values(meetingData.pages || {});
        pages[currentPageIndex] = updatedPage;
        // 重建 pages 对象（保留 key）
        const keys = Object.keys(meetingData.pages || {});
        meetingData.pages = {};
        pages.forEach((p, i) => {
          meetingData.pages[keys[i]] = p;
        });
        // 更新预览
        updatePreview(updatedPage);
      });
    }

    // 4. 更新预览
    function updatePreview(page) {
      document.getElementById('preview-title').textContent = page.title || '';
      document.getElementById('preview-text').innerHTML = 
        page.sections?.map(s => 
          `<div style="${Object.entries(s.style||{}).map(([k,v])=>`${k}:${v}`).join(';')}">${s.content}</div>`
        ).join('') || '无内容';
      
      // 设置背景（轮换）
      const totalBg = 23;
      const bgIndex = ((currentBgIndex - 1) % totalBg) + 1;
      document.getElementById('preview-bg').style.backgroundImage = 
        `url('assets/background/slide${bgIndex}.jpg')`;
    }

    // 5. 切换模式
    document.getElementById('toggle-mode').addEventListener('click', function() {
      const isPreview = this.textContent.includes('预览');
      if (isPreview) {
        // 进入全屏预览
        document.getElementById('editor-container').style.display = 'none';
        document.getElementById('preview-container').style.display = 'block';
        document.body.classList.add('preview-mode');
        this.textContent = '返回编辑模式';
        
        // 绑定翻页快捷键
        document.addEventListener('keydown', handlePreviewKeydown);
      } else {
        // 返回编辑
        document.getElementById('preview-container').style.display = 'none';
        document.getElementById('editor-container').style.display = 'block';
        document.body.classList.remove('preview-mode');
        this.textContent = '切换到全屏预览';
        document.removeEventListener('keydown', handlePreviewKeydown);
      }
    });

    // 6. 预览模式快捷键
    function handlePreviewKeydown(e) {
      if (e.key === 'ArrowRight' || e.key === ' ') {
        // 下一页
        currentBgIndex++;
        updatePreview(Object.values(meetingData.pages || {})[currentPageIndex]);
      } else if (e.key === 'ArrowLeft') {
        // 上一页
        currentBgIndex--;
        updatePreview(Object.values(meetingData.pages || {})[currentPageIndex]);
      } else if (e.key === 'Escape') {
        // 退出预览
        document.getElementById('toggle-mode').click();
      }
    }

    // 初始化
    loadMeetingData();
  </script>
</body>
</html>